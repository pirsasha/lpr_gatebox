# Аудит LPR GateBox (gatebox + rtsp_worker + UI)

Дата: 2026-02-27

## A) Красные флаги (сборка/рантайм)

1. **`NameError` в `fetch_settings()` (мертвый, но сломанный путь)**  
   Файл `app/worker/http_client.py`: функция `fetch_settings()` вызывает `http_get_json`, который в модуле не определён. Если кто-то начнёт использовать эту функцию, будет runtime-падение.  
   **Фикс:** либо удалить функцию, либо заменить на `get_json`/`fetch_settings_json`.

2. **`camera/test` игнорирует `timeout_sec` и может зависать на `VideoCapture`**  
   В `app/api/ui_api.py` есть поле `timeout_sec`, но в реализации не используется. Открытие RTSP идёт через `cv2.VideoCapture(rtsp_url)` без явного open/read timeout. На плохих RTSP это может подвешивать обработчик запроса.  
   **Фикс:** задавать timeout через OpenCV/FFmpeg options (или выносить test в worker с watchdog).

3. **Обновление может тянуть “не тот источник образов” (симптом: UI «обновил», но версия старая)**  
   - `docker-compose.prod.yml` использует `ghcr.io/...:${TAG:-stable}`.  
   - `docker-compose.yml` использует `build:` для `gatebox/rtsp_worker` (а updater образ локальный).  
   - `updater/app.py` делает `compose pull` и `compose up` по `COMPOSE_FILE` (по умолчанию `docker-compose.yml`).  
   В такой конфигурации `pull` для build-сервисов не даст новый git tag из registry, и система может остаться на старом локальном образе.
   **Фикс:** в проде запускать updater c `COMPOSE_FILE=docker-compose.prod.yml` и задавать `TAG`; либо унифицировать compose на image-only для production.

## B) UI проблемы

1. **UI пишет множество ключей, которые rtsp_worker не применяет в runtime overrides**  
   На странице `Settings` сохраняются ключи вроде `AUTO_MODE`, `TRACK_ENABLE`, `FREEZE_ENABLE`, `RTSP_TRANSPORT`, `LIVE_SAVE_QUAD` и др., но `_OVERRIDABLE` в `runner_impl.py` их не содержит, значит они остаются в `settings.json`, но не влияют на running worker.  
   **Как воспроизвести:** изменить такие флаги в UI → нажать «Сохранить и применить» → в логике worker поведение не меняется до рестарта (а часть — никогда).  
   **Фикс:** либо добавить ключи в `_OVERRIDABLE`, либо убрать эти контролы из UI/пометить как restart-only.

2. **Дубли/рассинхрон UI-слоёв**  
   В проекте параллельно лежат `ui/src/api.js` и `ui/src/api/gatebox.ts`, а также две страницы камеры (`CameraPage.tsx` и `Camera.tsx`) и `QuickSetup.tsx`, который не подключён в роутинг. Это повышает риск вызова устаревших эндпоинтов и регрессий при изменениях API.
   **Фикс:** удалить/архивировать неиспользуемые страницы и API-обёртки, оставить единый клиент API.

## C) Конфиги/дубликаты настроек и источник истины

### UI field → API → storage → runtime

- `Настройки → gate.min_conf` → `PUT /api/v1/settings` → `settings.json: gate.min_conf` → применяется в `main.py` через callback `set_apply_callback` и `GateDecider`.
- `Камера → camera.rtsp_url/enabled` → `PUT /api/v1/settings` → `settings.json: camera.*` → читается `rtsp_worker` через `fetch_camera_settings()` и меняется без рестарта.
- `Settings → rtsp_worker.overrides.*` → `PUT /api/v1/settings` → `settings.json: rtsp_worker.overrides` → применяется только если ключ есть в `_OVERRIDABLE`.
- `Whitelist` → `PUT /api/v1/whitelist` + `POST /api/v1/whitelist/reload` → `whitelist.json` + `decider.reload_whitelist()`.
- `MQTT` (`mqtt.*`) → `PUT /api/v1/settings` → `settings.json` → применяется через `api_apply_settings()` в `main.py`, обновляет `_mqtt_cfg`.
- `CloudPub` (`cloudpub.*`) → `PUT /api/v1/settings` → `settings.json` → читается `ui_api` для `cloudpub/status/connect/disconnect`.

### Рекомендация

- Явно разделить `rtsp_worker.overrides` на:
  - `runtime_hot` (можно без рестарта),
  - `requires_restart` (только с рестартом worker).
- В UI показывать бейдж “требуется рестарт” для restart-only ключей.

## D) CPU/perf bottlenecks и предложения

### Текущий pipeline rtsp_worker

`grab frame` → `ROI crop` → `detector.detect` (по DET_FPS) → `tracking` → `crop` → `rectify`/`deskew`/`upscale` → `cv2.imencode` → `HTTP post /infer`.

### Узкие места

1. **YOLO detect + preprocess на каждом det-тикe** (дорого на CPU).
2. **JPEG encode на каждый send** + отправка синхронным `requests.post`.
3. **Debug IO (`cv2.imwrite`)** при `SAVE_EVERY > 0` может забирать заметный CPU/диск.
4. **`requests` без Session keep-alive** — лишние TCP handshakes.

### Quick wins (1–2 часа)

- Перейти на `requests.Session()` в `worker/http_client.py` и переиспользовать соединение.
- Ограничить `SEND_FPS <= DET_FPS` в UI-валидации, чтобы не генерировать лишние encode/post.
- На mini-PC дефолты: `DET_IMG_SIZE=416`, `READ_FPS=10-12`, `DET_FPS=1.5-2`, `SEND_FPS=1`, `JPEG_QUALITY=80-85`, `SAVE_EVERY=0`.

### Medium (1–2 дня)

- Ввести bounded queue между detect и send (`maxsize=1..2`, drop-old policy) для backpressure.
- Для `camera/test` сделать bounded timeout и отдельный worker thread/process.
- Добавить rate-limit на verbose logging (`[infer]`) даже при debug.

### Long (архитектурно)

- Разделить `rtsp_worker` на декодер + inference loop с явной очередью кадров и telemetry по stage latency (p50/p95).
- Для ultra-low CPU режима: static ROI + adaptive DET_FPS по активности сцены.

### Пример безопасных env для mini-PC (CPU-only)

```env
# rtsp_worker
READ_FPS=12
DET_FPS=2
SEND_FPS=1
DET_IMG_SIZE=416
DET_CONF=0.35
DET_IOU=0.45
JPEG_QUALITY=82
RECTIFY=1
UPSCALE_ENABLE=0
SAVE_EVERY=0
LOG_EVERY_SEC=5
HTTP_TIMEOUT_SEC=1.5

# gatebox
MIN_CONF=0.85
CONFIRM_N=2
CONFIRM_WINDOW_SEC=4.0
COOLDOWN_SEC=15
REGION_CHECK=1
REGION_STAB=1
```

## E) План работ

### Быстрые (1–2 часа)
- [ ] Починить/удалить `fetch_settings()` в `http_client.py`.
- [ ] `camera/test`: реализовать реальный timeout и корректный fail-fast.
- [ ] В UI скрыть/пометить override-ключи, которые не hot-apply.

### Средние (1–2 дня)
- [ ] Ввести explicit restart-only список ключей + UI индикацию.
- [ ] Перевести HTTP-клиент worker на `requests.Session` + retry/backoff для heartbeat/settings.
- [ ] Привести updater к production source of truth: `docker-compose.prod.yml + TAG`.

### Большие
- [ ] Архитектурно разделить pipeline на очереди и stage metrics.
- [ ] Единый API-клиент UI (удаление дублей `api.js` / `api/gatebox.ts`).

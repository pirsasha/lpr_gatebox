name: lpr_gatebox

services:
  gatebox:
    image: ghcr.io/pirsasha/lpr_gatebox-gatebox:${TAG:-stable}
    restart: unless-stopped
    ports:
      - "${GATEBOX_PORT:-8080}:8080"
    environment:
      APP_VERSION: "${TAG:-stable}"

      MODEL_PATH: "/models/plate_ocr.onnx"
      SETTINGS_PATH: "/config/settings.json"

      MQTT_ENABLED: "${MQTT_ENABLED:-1}"
      MQTT_HOST: "${MQTT_HOST}"
      MQTT_PORT: "${MQTT_PORT}"
      MQTT_USER: "${MQTT_USER}"
      MQTT_PASS: "${MQTT_PASS}"
      MQTT_TOPIC: "${MQTT_TOPIC:-gate/open}"

      # если UI где-то обращается к updater — можно раскомментить и оставить:
      # UPDATER_BASE_URL: "http://updater:9010"

    volumes:
      - ./models:/models:ro
      - ./config:/config

    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8080/api/v1/health').read(); print('ok')"]
      interval: 10s
      timeout: 5s
      retries: 15


  rtsp_worker:
    image: ghcr.io/pirsasha/lpr_gatebox-rtsp-worker:${TAG:-stable}
    restart: unless-stopped
    environment:
      APP_VERSION: "${TAG:-stable}"
      INFER_URL: "http://gatebox:8080/infer"
      SETTINGS_BASE_URL: "http://gatebox:8080"
      SETTINGS_POLL_SEC: "${SETTINGS_POLL_SEC:-1.5}"

      RTSP_URL: "${RTSP_URL}"

      READ_FPS: "${READ_FPS:-10}"
      DET_FPS: "${DET_FPS:-8}"
      SEND_FPS: "${SEND_FPS:-6}"

      DET_MODEL_PATH: "/models/license-plate-finetune-v1s.pt"
      DET_CONF: "${DET_CONF:-0.40}"
      DET_IOU: "${DET_IOU:-0.45}"
      DET_IMG_SIZE: "${DET_IMG_SIZE:-416}"

      ROI: "${ROI:-}"
      PLATE_PAD: "${PLATE_PAD:-0.14}"

      RECTIFY: "${RECTIFY:-1}"
      RECTIFY_W: "${RECTIFY_W:-320}"
      RECTIFY_H: "${RECTIFY_H:-96}"

      REFINE_INNER_PAD: "${REFINE_INNER_PAD:-0.03}"
      REFINE_MIN_AREA_RATIO: "${REFINE_MIN_AREA_RATIO:-0.03}"

      DEBUG_SAVE: "${DEBUG_SAVE:-0}"

    volumes:
      - ./models:/models:ro
      - ./debug:/work/debug
      - ./config:/config

    depends_on:
      gatebox:
        condition: service_healthy


  updater:
    image: ghcr.io/pirsasha/lpr_gatebox-updater:${TAG:-stable}
    restart: unless-stopped
    ports:
      - "${UPDATER_PORT:-9010}:9010"
    environment:
      # --- совместимость со "старыми" именами env (у тебя уже было) ---
      PROJECT: "/project"
      COMPOSE: "/project/docker-compose.prod.yml"
      PROJECT_NAME: "lpr_gatebox"
      SERVICES: "gatebox,rtsp_worker,updater"
      HEALTH_URL: "http://gatebox:8080/api/v1/health"
      UPDATE_FALLBACK_BUILD: "0"

      # --- дополнительные (не мешают, но делают поведение стабильнее) ---
      PROJECT_DIR: "/project"
      COMPOSE_FILE: "/project/docker-compose.prod.yml"
      CONFIG_DIR: "/config"
      COMPOSE_PROJECT_NAME: "lpr_gatebox"
      SELF_CONTAINER: "updater"

    volumes:
      - ./:/project
      - /var/run/docker.sock:/var/run/docker.sock
      - ./config:/config
      # HOTFIX: подмена кода updater без пересборки образа
      - ./updater/app.py:/app/app.py:ro